- [Вывод информации о взаимных блокировках](#вывод-информации-о-взаимных-блокировках)

# Вывод информации о взаимных блокировках

При любом обращении к СУБД, но не чаще чем 1 раз в 2 секунды, выполняется дополнительное обращение к СУБД с запросом, какой поток был заблокирован и каким потоком. Результатом такого запроса является таблица пар («жертва блокировки», «источник блокировки»), где:

● Жертва блокировки – идентификатор соединения с СУБД, которое ожидает блокировки.

● Источник блокировки – идентификатор соединения с СУБД, которое установило блокировку.

Если в кластере несколько рабочих процессов, то запрос выполняется одним из них. Запросы о взаимных блокировках нумеруются.

Данные из полученной таблицы добавляются к контексту каждого потока, которому соответствуют полученные идентификаторы соединений с СУБД, и будут отображены в качестве значения блокировочных свойств очередного события технологического журнала. После того как в потоке, к контексту которого добавлена информация о блокировках, будет завершено очередное событие технологического журнала, к этому событию будут добавлены блокировочные свойства. При этом если поток был жертвой блокировки, то события блокировки будут очищены после вывода. Если поток был источником, то очистка выполняется при закрытии или откате транзакции.

Информация о блокировках добавляется к потокам в следующем порядке:

● Если поток-жертва еще не знает об этом, то ему устанавливается номер запроса и идентификатор потока-источника блокировки.

● К потоку-источнику блокировки добавляется номер запроса, только если у него есть жертвы, которые об этом еще не знали.

Информация о блокировках:

● поток является источником, момент обнаружения;

● поток является жертвой, момент обнаружения;

● номер запроса (если поток является жертвой);

● список номеров запросов (если поток является источником);

● номер соединения источника (если поток является жертвой).

Блокировочные свойства событий:

● lka='1' – поток является источником блокировки.

● lkp='1' – поток является жертвой блокировки.

● lkpid – номер запроса к СУБД, «кто кого заблокировал» (только для потока-жертвы блокировки). Например, ‘423’.

● lkaid – список номеров запросов к СУБД, «кто кого заблокировал» (только для потока-источника блокировки). Например, ‘271,273,274’.

● lksrc – номер соединения источника блокировки, если поток является жертвой, например, ‘23’.

● lkpto – время в секундах, прошедшее с момента обнаружения, что поток является жертвой. Например: ‘15’.

● lkato – время в секундах, прошедшее с момента обнаружения, что поток является источником блокировок. Например, ‘21’.

Таким образом, для анализа блокировок необходимо найти в технологических журналах процессов rphost первое событие со свойствами lka и lkp, узнать значения свойств lkaid, lkpid и найти все события с этими значениями свойств в журналах всех рабочих процессов кластера. По найденной группе событий можно установить, кто кого заблокировал, на сколько времени и что они при этом делали.

Также в свойстве Txt события TLOCK в технологическом журнале может быть отображено пространство имен, в котором наложена блокировка.