- [Чек-лист быстрого ускорения системы](#чек-лист-быстрого-ускорения-системы)
  - [Настроить параллелизм в MS SQL Server](#настроить-параллелизм-в-ms-sql-server)
    - [Несколько ситуаций, при которых не стоит отключать распараллеливание:](#несколько-ситуаций-при-которых-не-стоит-отключать-распараллеливание)
  - [Проверить, сколько ядер используют MS SQL Server и 1С](#проверить-сколько-ядер-используют-ms-sql-server-и-1с)
  - [Проверить, сколько ядер используют 1С](#проверить-сколько-ядер-используют-1с)
  - [Проверить настройку Turbo Boost.](#проверить-настройку-turbo-boost)
  - [Убрать лишнее](#убрать-лишнее)
  - [Введение в APDEX](#введение-в-apdex)
    - [Определение списка ключевых операций](#определение-списка-ключевых-операций)
    - [Определение целевого времени](#определение-целевого-времени)
    - [Определение приоритета](#определение-приоритета)
    - [Сбор информации о реальном времени выполнения](#сбор-информации-о-реальном-времени-выполнения)
    - [Вычисление APDEX](#вычисление-apdex)

## Чек-лист быстрого ускорения системы

- Настроить параллелизм в MS SQL Server.
- Проверить, сколько ядер используют MS SQL Server и 1С.
- Проверить настройку Turbo Boost.
- Включить механизм версионирования в MS SQL для 8.2.
- Проверить выполнение регламентных операций СУБД и 1С.
- Использовать таблицы итогов регистров сведений.
- Убрать лишнее.

### Настроить параллелизм в MS SQL Server

Оставить настройку Max degree of parallelism = 0, но установить настройку Cost threshold for parallelism = 30.

Такая настройка означает, что MS SQL будет самостоятельно решать, сколько потоков использовать для выполнения одного запроса, но распараллеливание будет включаться, только если стоимость плана запроса будет выше 30.

Стоимость плана измеряется в неких условных единицах и отражает, насколько «тяжелым» является запрос для исполнения. Чем выше стоимость, тем сильнее запрос нагружает систему. При настройках по умолчанию параллельность включается, если стоимость плана выше 5. Значение 30 — не какая-то сакральная величина: просто, с точки зрения автора, оно подходит для большинства систем.

Благодаря такой настройке параллельность будет использоваться только для действительно сложных запросов. Запросы полегче продолжат выполняться в один поток — им распараллеливание все равно не дает заметного ускорения.

Следует отметить, что это решение не освобождает от необходимости оптимизировать «тяжелые» запросы, но оно хотя бы не мешает другим операциям выполняться быстро.

#### Несколько ситуаций, при которых не стоит отключать распараллеливание:

- Описанный в документации случай, когда один запрос при распараллеливании замедляет всех — не самый распространенный паттерн. Чаще неоптимальный запрос выполняется медленно в один поток, хотя мог бы выполняться гораздо быстрее в несколько потоков, при этом несильно загружая процессор.
- Если отключить распараллеливание на уровне сервера, тогда и регламентные операции по умолчанию тоже будут выполняться в один поток. Чтобы этого избежать, нужно указывать настройку распараллеливания (MAXDOP = 0) для регламентного задания дефрагментации/реиндексации, чего многие, к сожалению, не делают.
- Новый механизм реструктуризации работает гораздо быстрее, если включено распараллеливание. Об этом сказано и в документации. Там же предлагается каждый раз перед реструктуризацией включать параллельность, а после обновления — отключать. Но все мы люди, и часто разработчики просто забывают установить параметр в нужное значение. В итоге реструктуризация больших таблиц даже с новым механизмом идет медленно.
- Ожидания CXPACKET зачастую интерпретируются неправильно. Их наличие далеко не всегда говорит о проблемах с распараллеливанием. Если хочется больше узнать об этом, подробности Вы найдете в статье [Troubleshooting the CXPACKET wait type in SQL Server](https://www.sqlshack.com/troubleshooting-the-cxpacket-wait-type-in-sql-server/).

### Проверить, сколько ядер используют MS SQL Server и 1С

Чтобы узнать, сколько логических процессоров (ядра, в том числе и гиперпоточные) задействует Ваш экземпляр MS SQL, следует выполнить следующий запрос

``` sql 
select * from sys.dm_os_schedulers where status = ‘VISIBLE ONLINE’ and is_online = 1
```

### Проверить, сколько ядер используют 1С
Важно помнить, что у 1С тоже есть ограничения по количеству используемых ядер. Например, версия ПРОФ может использовать только 12 ядер и, если поставить ее на 24-ядерный сервер, то половина процессорных мощностей будет простаивать.

Если на сервере больше 12 ядер и Вы хотите, чтобы 1С использовала их все, необходимо приобрести версию КОРП.

### Проверить настройку Turbo Boost.

Для сервера 1С критически важна частота процессора — чем она выше, тем лучше.

В большинстве процессоров есть возможность динамически менять частоту в зависимости от нагрузки — это позволяет процессору работать на частоте выше номинальной. У Intel такая технология называется Turbo Boost, у AMD — Turbo Core.


Turbo Boost включается в BIOS, но чтобы он полноценно работал, необходимо в настройках электропитания операционной системы установить режим электропитания Высокая производительность. Если этого не сделать, ОС будет занижать частоту процессора для экономии электричества.

### Убрать лишнее

Этот способ ускорения системы заключается в том, чтобы отключить все, что не используется, но забирает ресурсы. Особенно это касается типовых конфигураций.

Кому-то покажется, что это совет от капитана Очевидность. Но стоит отбросить сарказм — есть множество баз, в которых работают все стандартные регламентные задания и оставлены настройки по умолчанию.

Проведите ревизию включенных регламентных заданий. Действительно ли все эти задания нужны? Может, часть относится к механизмам, которые Вы не используете?

Ситуация усугубляется, когда на сервере расположено большое количество баз: часть из них для разработки, часть — для тестов, еще часть кто-то когда-то зачем-то создал. В каждой из них выполняются задания, обновление полнотекстового поиска и т. д.

Все это никак не помогает производительности Вашей системы, поэтому стоит отключить все лишнее.

Первое, на что нужно обратить внимание при ревизии — это полнотекстовый поиск. Если он не используется, тогда лучше его отключить, чтобы он зря не «съедал» ресурсы системы.

Если же полнотекстовый поиск используется, тогда стоит оставить свойство «Полнотекстовый поиск» в значении Использовать только для тех реквизитов, где он действительно необходим. У остальных объектов следует его отключить.

### Введение в APDEX

Методика APDEX состоит из следующих шагов:

- Определение списка ключевых операций. Ключевые операции являются индикаторами скорости работы системы.
- Определение целевого времени ключевых операций. Для каждой операции устанавливается целевое время — время выполнения, которое полностью устраивает пользователя.
- Определение приоритета ключевых операций.
- Сбор информации о реальном времени выполнения ключевых операций. Фиксируется время выполнения каждой ключевой операции.
- Вычисление APDEX. Рассчитывается индекс производительности.

#### Определение списка ключевых операций

Ключевая операция — это такая операция в информационной системе, которая критически важна для нормального функционирования организации.

Типичными ключевыми операциями являются:

- проведение документов,
- формирование отчетов,
- выполнение различных обработок,
- открытие форм.

Пример

В магазине ключевой операцией будет проведение документов Продажа товара. Если они будут проводиться медленно, это может сказаться на бизнесе и привести к огромным очередям у касс, недовольству покупателей и раздражению кассиров.

Ключевая операция необязательно выполняется много раз в день. Это может быть и редкое, но критически важное действие: расчет себестоимости, восстановление последовательности и т. д.

#### Определение целевого времени

Целевое время — это время выполнения ключевой операции, которое устраивает заказчика.

Возможна ситуация, когда документ может содержать как 10 строк, так и 1 000. Естественно, требовать одинакового времени проведения в этом случае будет неправильно. В такой ситуации необходимо разбить одну ключевую операцию на несколько и к каждой из них определить разные требования по времени выполнения.

Например, документ, в котором содержится до 100 строк, — это одна ключевая операция с одним целевым временем, от 100 до 1000 строк — другая ключевая операция с другим целевым временем и так далее. Все эти пороги необходимо обязательно согласовать с заказчиком или пользователями.

Важно понимать: если выполняется групповая обработка чего-либо, то вся групповая обработка — это одна ключевая операция. Соответственно и целевое время определяется для выполнения всей обработки.

#### Определение приоритета

Приоритет ключевой операции — это степень важности ключевой операции с точки зрения деятельности организации. Самой важной ключевой операции присваивается приоритет 1, менее важной — 2 и т. д. Таким образом, приоритет помогает выстроить порядок, в котором будет производиться оптимизация системы.

#### Сбор информации о реальном времени выполнения

После определения целей и приоритетов необходимо собрать информацию о фактическом времени выполнения ключевых операций. Для этого можно использовать как инструменты фирмы 1С, например, подсистему Оценка производительности из Библиотеки стандартных подсистем (БСП), так и альтернативные инструменты, например, облачный сервис контроля производительности по методике APDEX.

**Приоритет должен быть уникальным — не может быть двух операций с приоритетом 1.**

#### Вычисление APDEX

Индекс производительности рассчитывается по следующей формуле:

APDEX = (NS + NT / 2) / N

Где:

NS — число выполнений со временем от 0 до Т (Т — целевое время операции)
NT — число выполнений со временем от T до 4T
N — общее число выполнений операции


Источники:
- [Курсы 1с рф](https://xn----1-bedvffifm4g.xn--p1ai/news/2021-12-14-optimization-without-optimization/)
- [Введение в APDEX. Курсы 1с рф](https://xn----1-bedvffifm4g.xn--p1ai/news/2021-12-03-apdex/)
- [Как использовать подсистему «Оценка производительности» для измерения времени операций (статья + видео)](https://xn----1-bedvffifm4g.xn--p1ai/news/2021-12-03-performance-evaluation/)